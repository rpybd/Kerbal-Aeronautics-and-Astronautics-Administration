# 密码定向攻击模块

## 代码功能描述
### 1.项目目标
实现Targeted Online Password Guessing：An Underestimated Threat论文中的两种定向猜测算法TARGUESS I、Ⅱ，完成密码库的训练学习功能和定向猜测密码生成功能。

### 2.可维护性需求
1. 训练集和模型的格式设计需要保证便于添加新的个人信息的支持。
1. 定向攻击猜测模型训练模块需要保证在训练集中引入新的个人信息字段时，能够方便的修改训练相关的代码。
1. 定向攻击猜测密码生成模块需要保证在模型中引入新的个人信息结构时，能够方便的修改密码生成相关的代码。
1. 代码需要提供必要的注释。

定向攻击猜测模型训练模块和定向攻击猜测密码生成模块需要提供相应的测试数据。

### 3.相关代码
#### （1）项目主要代码：
- targuess1_train

功能：该模块用于对targuess I算法模型进行训练，并按照要求读取并解析配置文件，然后根据读取的参数进行训练并输出模型文件和log文件。

训练过程：加入了个人信息的PCFG的训练过程。首先读取用户的个人信息和口令后，使用用户个人信息的变换在口令中进行匹配，然后得到该口令的pattern。然后按照PCFG的方法进行排序，最后把各个pattern和各类型的字符串以及相应的概率输出到模型文件中。训练集格式为：邮箱名\t口令\t姓名拼音（用|隔开）\t身份证号\t用户名\t手机号\t生日。若该个人信息缺失，则用空串代替。

具体代码文件：

    a. targuess1_train.cpp：模块主代码，主要包含三个函数：
            string getPattern(string email, string psw)：该函数传入的参数是用户的邮箱和口令，实现了根据个人信息获取口令的pattern；
            void addDLSPattern(string psw, string pat_str)：该函数传入的参数是psw和pattern字符串pat_str，功能是把psw中的DLS段插入到map中进行计数；
            void sortTable()：该函数实现了对统计后的DLS段根据概率进行排序，具体来说就是前面统计的时候是根据字典序进行排序的，现在以概率作为key插入到各个类型map中，以此来实现排序。

    b. person.h和person.cpp：把个人信息相关的变量和相关的函数封装起来。
        - 该类包括几个个人信息的变量：string email, name, birth, account, phone, psw, gid：
        - 以及相关的函数：
            void findStr(string& pat_str, string psw, string str, char c)：该函数传入的参数为口令的pattern字符串pat_str，口令psw，需要查找的个人信息的变换str以及替换的label c。该函数的功能是在psw中查找str，若成功，则在pat_str中相应的位置替换成label c。
            void processPhone(string& pat_str, string psw)：该函数传入的参数是pattern字符串pat_str和口令psw，函数调用上面的findStr函数，在用户的口令中查找变量phone，然后替换成label C。
            void processName(string& pat_str, string psw)：该函数传入的参数与上面相同，函数对姓名信息name进行变形，然后调用findStr函数对pattern字符串匹配的name信息替换成相应的标签。
            void processBirth(string& pat_str, string psw)：该函数传入的参数与上面相同，函数对生日信息birth进行变形，然后调用findStr函数对pattern字符串匹配的birth信息替换成相应的标签。
            void processEmail(string& pat_str, string psw)：该函数传入的参数与上面相同，函数对邮箱信息email进行变形，然后调用findStr函数对pattern字符串匹配的email信息替换成相应的标签。
            void processAccount(string& pat_str, string psw)：该函数传入的参数与上面相同，函数对用户名信息account进行变形，然后调用findStr函数对pattern字符串匹配的account信息替换成相应的标签。
            void processGid(string& pat_str, string psw)：该函数传入的参数与上面相同，函数对身份证信息gid进行变形，然后调用findStr函数对pattern字符串匹配的account信息替换成相应的标签。

- targuess1_guess

功能：该模块根据targuess I的训练模块的模型文件，根据用户个人信息生成密码，并按照要求读取并解析配置文件，然后根据读取的参数输出生成密码文件和log文件。

生成过程：首先配置文件和模型文件中读取模块的参数以及训练模型的参数。然后读取用户的个人信息，对于每个用户，分别对每个PCFG生成的preguess进行个人信息的填充，然后输出，直到满足约束条件。

具体文件：

    a.targuess1_guess.cpp：模块主代码，包含下面几个函数：
            void genPersonalGuess()：该函数对当前弹出的guess进行个人信息的填充。当前弹出的guess用全局变量保存，当前用户的个人信息进行变换后用一个结构体保存。然后直接对guess中的个人信息部分进行替换。
            void genNext(guess top) ：该函数传入的参数是优先队列的堆顶元素top，然后根据top的pattern和pivot填充相同类型的下一个字符串，再插入到优先队列中，以此生成下一组guess。
            void genGuess(person & pp) ：该函数传入的参数是用户的个人信息，然后根据个人信息调用personTran(pp)生成个人信息的变换。生成guess的方法跟普通的PCFG类似，这里不再赘述。不同之处在于，输出guess之前，先对guess中的个人信息部分进行填充，然后再输出。
            long long calMaxGuessNum()：该函数的功能是估计最大可生成的guess数，可用于估计剩余时间。
        
    b.personTran.h和personTran.cpp：该类的作用是把个人信息的变形封装起来。
        - 该类包括几个个人信息变形的变量和函数：
            bool dd：表示email前缀是否有数字
            bool ll：表示email前缀是否有字母
            bool ad：表示account是否有数字
            bool al：表示account是否有字母
            int name_len：表示name的长度
            unsigned int pos：表示email查找@的位置

            char *email[3]：保存email信息的3种变形，详见第三节对各种个人信息变形的解释
            char *name[8]：保存name信息的8种变形
            char *birth[12]：保存birth信息的12种变形
            char *account[3]：保存account信息的3种变形
            char *phone：保存phone信息的1种变形
            char *gid[2]：保存gid信息的2种变形

            int email_len[3]：保存各种变形的长度，下同
            int nname_len[8];
            int birth_len[12];
            int account_len[3];
            int phone_len;
            int gid_len[2];
- targuess2_train

功能：该模块用于对targuess II算法模型进行训练，并按照要求读取并解析配置文件，然后根据读取的参数进行训练并输出模型文件和log文件。

训练过程：首先读取用户新旧口令对，然后算法对相似的口令对进行分析，通过编辑矩阵分析从旧口令在结构级和字段级变换到新口令的过程，然后把相应的概率保存下来，经过平滑处理后输出到模型文件中。训练集格式为：邮箱名\t旧口令\t新口令\t相似度（可以忽略，只是方便看），程序中只用到了前三个数据。

具体代码文件：

    a. targuess2_train.cpp：模块主代码，下面几个函数：
            string pat2str(pattern pat)：该函数传入的参数为口令的pattern，作用是把pattern转换为字符串。
            float ed_dis(string a, string b)：该函数传入的参数为两个字符串a和b，通过计算a和b的编辑矩阵，得到a到b的编辑距离，然后把编辑距离除以a和b间较大的长度，得到a和b的相似度并返回。
            void getOp(string a, string b, char pat)：该函数传入的参数为两个字符串a和b，以及a的字符类型pat。这里的a和b是两个由相同字符类型构成的字符串，pat表示该字符类型，如D、L、S。然后通过计算a和b的编辑矩阵，并从右下角的值进行回溯，得到从a变换到b的路径，并在回溯的过程中把相应的概率保存下来。
            void getPatOp(pattern pat1, pattern pat2, string p1, string p2)：该函数传入的参数为两个口令的pattern以及这两个口令。这里通过对口令的结构进行编辑矩阵的计算，然后通过分析从结构pat1变换到pat2的路径，在回溯的过程把相应的概率保存下来。
            string Capitalize(string old, const pattern & pat, int type)：该函数传入的参数是要变换的口令、口令的pattern以及大小写变换的类型，有5种，分别是：type:0-首字母大写，1-全大写，2-全小写,3-首字母小写，4-全小写后首字母大写，返回变换后的口令。
            string Reverse(string old, const pattern& pat, int type)：该函数传入的参数是要变换的口令、口令的pattern以及翻转变换的类型，有3种，分别是：type: 0-结构翻转，1-全部翻转，2-内部翻转，返回变换后的口令。
            pattern getPattern(string psw)：该函数传入的参数是用户的口令，通过遍历字符串，得到该字符串的pattern并返回。
            void analyse(string p1, string p2)：该函数传入的参数是两个口令字符串p1和p2，作用是分析从p1变换到p2的过程。
            void sp_analyse(string p1, string p2)：该函数传入的参数是两个口令字符串p1和p2，作用是分析p2是否是从p1经过特殊变换得到的。特殊变换包括5种大小写变换以及3种翻转变换。
            bool isScience(string str)：由于有些数据是科学计数法表示的，明显是错误的数据。所以这里判断是否是科学计数法。

    b. person.h和person.cpp：把个人信息相关的变量和相关的函数封装起来。
        - 该类包括几个个人信息的变量：string email, name, birth, account, phone, psw, gid：
        - 以及相关的函数：
            void findStr(string& pat_str, string psw, string str, char c)：该函数传入的参数为口令的pattern字符串pat_str，口令psw，需要查找的个人信息的变换str以及替换的label c。该函数的功能是在psw中查找str，若成功，则在pat_str中相应的位置替换成label c。
- targuess2_guess

功能：根据targuess2的训练模块的模型文件，根据用户的sispsw生成密码，并按照要求读取并解析配置文件，然后根据读取的参数输出生成密码文件和log文件

生成流程：首先从配置文件和模型文件中读取模块的参数以及训练模型的参数。然后读取上面预先得到的PCFG结构信息、markov字段信息以及top口令的信息。最后读取用户的sispsw信息，对这个sispsw进行结构级变换以及字段级变换，插入到优先队列中。对优先队列概率最大的guess重复上述步骤。

组成文件：

    targuess2_guess.cpp：主代码，包含下面几个结构体和函数：
        - 结构体
            Guess结构体用于保存生成的guess，并插入到优先队列中。
            next_pro结构体用于保存markov得到的前缀后面接字符的概率。
        - 函数
            pattern getPattern(string psw)：该函数传入的参数是用户的口令，通过遍历字符串，得到该字符串的pattern并返回。
            string pat2str(pattern pat)：该函数传入的参数为口令的pattern，作用是把pattern转换为字符串。
            loat ed_dis(string a, string b)：该函数传入的参数为两个字符串a和b，通过计算a和b的编辑矩阵，得到a到b的编辑距离，然后把编辑距离除以a和b间较大的长度，得到a和b的相似度并返回。
            void readData()：该函数用于读取PCFG的结构级数据和Markov的字段级数据。
            void readTop()：该函数用于读取top口令及相应的概率。
            string Capitalize(string old, const pattern & pat, int type)：该函数传入的参数是要变换的口令、口令的pattern以及大小写变换的类型，有5种，分别是：type:0-首字母大写，1-全大写，2-全小写,3-首字母小写，4-全小写后首字母大写，返回变换后的口令。
            string Reverse(string old, const pattern& pat, int type)：该函数传入的参数是要变换的口令、口令的pattern以及翻转变换的类型，有3种，分别是：type: 0-结构翻转，1-全部翻转，2-内部翻转，返回变换后的口令。
            void check_vad(const Guess & next_guess)：该函数传入参数为由优先队列顶部元素top生成的next_guess，判断next_guess是否满足限制条件，若满足则插入到优先队列中。 
            void genNext(Guess top)：该函数传入的参数为优先队列的顶部元素top，作用是对top进行结构级变换和字段级变换生成下一组guess以及计算相应的概率，然后通过调用check_vad函数判断是否满足限制条件。
            void genGuess(string old)：该函数传入的参数是曾用口令sispsw。首先把sispsw和top口令插入到优先队列中。然后弹出队列中的顶部元素，然后把该元素的概率乘上out_pro（即弹出的guess作为最终guess的概率，这个概率为在训练集中直接使用sispsw作为新口令的比例，个人觉得这个值在0.5左右比较合适）输出到output文件中。该元素的概率乘上1-out_pro作为继续进行变换的概率，然后调用genNext函数对顶部元素进行变换。重复上述步骤直到优先队列为空或者生成的guess数大于阈值。
            long long calMaxGuessNum(string psw)：该函数传入的参数是sispsw，用于估计可生成的guess数。估计的方法是不考虑具体的口令，假设增加的字符概率都相等，增加和删除的概率也相等，若变换后概率大于阈值，则把变换后的数量加到返回值上，然后把这个数值记录下来，进行下一次变换时，数量乘上这个数值。类似生成guess的方法重复这个步骤。
#### （2）辅助代码：
- targuess2_genPCFGdata

功能：该程序的作用是使用别的口令集，通过PCFG的方法得到D、L、S三种类型字符串在长度为1-10出现次数最多的若干个字符串以及相应的概率，用于targuess2_guess中进行结构级变换时增加的结构。

配置文件格式如下：

    [basic_config]
    training_set_path=F:/psw_dataset/rockyou.txt
    model_output_path=rockyou_PCFG_data.txt
    max_output_num=10`
其中

    training_set_path为口令集的路径，该口令集可以是任意的口令集，格式为一行一个口令。
    model_output_path为得到的数据输出路径。
    max_output_num为输出每种结构（如D3）出现次数前max_output_num的字符串及概率。
- targuess2_genMarkovdata

功能：使用别的口令集，利用markov的方法，得到各个同种类型的前缀（如：全是数字或全是字母）后面接相同类型字符的概率，如：123后面接0-9的概率。用于targuess2_guess中进行内部变换即相同类型的字段中进行尾部增加的字符及相应的概率。

配置文件格式如下：

    [basic_config]
    training_set_path=F:/psw_dataset/yahoo.txt
    output_path=yahoo_markov_reverse_data.txt
    order=3
    is_reverse=true
其中

    training_set_path为口令集的路径，该口令集可以是任意的口令集，格式为一行一个口令。
    output_path为数据输出的路径
    order为markov考虑的前缀长度，如order=3表示考虑长度为三的前缀后面接同类型字符的概率
    is_reverse为是否把字符串颠倒再进行统计。这里把字符串颠倒进行统计等价于各后缀前面接同类型字符的概率。用于targuess2_guess中进行内部变换中进行首部增加字符及概率。
- targuess2_genToppsw

功能：使用从一个或多个口令集统计出的top口令，在一个口令重用匹配的目标口令集（数量尽量多点，不然top口令覆盖率太低）中统计并计算出相应的概率，用于在生成guess的时候插入到优先队列中，与用sispsw生成的guess一起进行排序。

配置文件格式如下：

    [basic_config]
    top_input_path=top.txt
    training_set_path=csdn_126_reuse.txt
    output_path=top_pro.txt
    smooth=0.1
其中

    top_input_path为top口令文件的路径，格式为一行一个口令（该文件可以自己统计，这里就不提供代码了）
    training_set_path为targuess2_guess的训练集
    output_path为输出文件路径
    smooth为平滑参数，默认为0.1
#### （3）公共模块接口
- read_config.h

功能：该文件包括一个函数，用于读取config中的内容并进行解析；config文件需用等号隔开，等号前面为参数名，等号后面为参数的值，然后把参数名和值存入map中传递。注意，该函数只对等号缺失进行了错误判断，请确保config文件格式无误，请勿在config文件中加注释。

参数：

    string path：config文件的路径。
    map<string, string> & rtn：用于存放解析后的参数名和值的容器。
- time.h和time.cpp：time.h

功能：定义了CTimer类的变量及函数，time.cpp实现了time.h所定义的函数。该类负责创建一个线程进行计时，实现定时向log文件打印摘要信息的功能。

参数：该类包括几个函数和固定的变量：

    CTimer()：CTimer类的构造函数，初始化打印间隔m_Elapse和线程m_hThread。
    ~CTimer()：CTimer类的析构函数，负责结束线程并打印结束的log信息。
    static time_t start_time：该变量为线程开始计时的时间，线程创建时获取系统当前时间。
    static float time_cost：该变量为线程计时消耗的时间，单位为秒。
    static string status：该变量为当前模块的状态，有running，sorting，predicting，finish等状态。
    void StartTimer(float nElapse): 传入参数为打印log的时间间隔，该函数的作用是设置打印时间间隔并创建计时线程开始计时，然后初始化start_time。
    void EndTimer()：该函数的作用是关闭计时线程。
    static DWORD WINAPI ThreadFunc(LPVOID pParam)：该函数是计时线程运行时执行的函数，使用一个while循环判断时间间隔是否满足条件，若满足则打印所需的log摘要信息。
    float m_Elapse：该变量为log打印的时间间隔，单位为秒。
    HANDLE m_hThread：该变量为计时线程。


详细描述代码的功能，并详细描述代码所需参数以及输入输出（包括格式要求）。
例如，蒙特卡洛算法：通过蒙特卡洛方法抽样计算给定口令的猜测次数，默认抽样个数为1000。输入为口令（长度1到30的字符串），输出为猜测次数（非负浮点数，该猜测次数为估计值，故可能不是整数）。

此处只需描述代码提供的外部接口，内部函数的描述可以以注释的形式写在代码中。

## 相关科研项目、论文
大致描述该代码的相关的项目或论文情况。

如果是现有研究论文的重现，说明原始论文的题目，最好附上原始论文实验的复现结果。

如果是实验室已发表论文的实验代码，指出对应论文的实验部分（包括图表的序号）。

如果是其他尚未形成论文、或论文尚未公开的代码，大致描述相关研究的动机、目标、内容等。

## 实验设计
该代码如果是为特定实验所写，注明相应的实验设计，包括数据集、参数设置等。

## 环境
编程语言、版本等，包括其他运行代码所需注意的事项。

如有必要，详细描述环境配置过程。

## 代码实现的关键算法
例如PCFG模型、Markov模型，概率表的数据结构以及相应的存取算法。

## Q & A
问题及解答

在交接过程中的疑问和回答，如果不方便放到其他条目，可以以问答的形式放在这。

## 其他改进的方向、思路
可以描述已经尝试但失败的改进方法、未尝试但有希望的的改进方法等。
